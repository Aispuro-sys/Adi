<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Para Adi ‚Äî Momentos</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,600;0,700;1,500&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0b1026;
      --bg-gradient: linear-gradient(135deg, #0b1026 0%, #16213e 50%, #1a1a2e 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.15);
      --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      --text-main: rgba(255, 255, 255, 0.95);
      --text-muted: rgba(255, 255, 255, 0.7);
      --accent-pink: #ffd700;
      --accent-green: #8ae6ff;
      --accent-blue: #8ae6ff;
      --radius: 32px;
    }

    * { box-sizing: border-box; }

    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      overflow-x: hidden;
      position: relative;
    }

    /* Lock Screen Overlay - Professional Redesign */
    #lockScreen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0a050b;
      background-image: radial-gradient(circle at center, #1a0d1f 0%, #050205 100%);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.8s ease, visibility 0.8s ease;
    }
    #lockScreen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .lock-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(25px);
      padding: 60px 40px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: center;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(255,255,255,0.05);
      animation: fadeInLock 1s ease-out;
    }
    @keyframes fadeInLock {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .lock-icon { 
      font-size: 3.5rem; 
      margin-bottom: 25px; 
      filter: drop-shadow(0 0 20px rgba(255, 133, 194, 0.3));
      opacity: 0.9;
    }
    .lock-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.2rem;
      color: #fff;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    .lock-riddle {
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.8;
      margin-bottom: 40px;
      font-weight: 300;
    }
    .lock-input-group {
      position: relative;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      transition: border-color 0.3s;
    }
    .lock-input-group:focus-within {
      border-color: var(--accent-pink);
    }
    .lock-input {
      width: 100%;
      padding: 15px 10px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.1rem;
      text-align: center;
      font-family: 'Playfair Display', serif;
      letter-spacing: 2px;
      outline: none;
    }
    .lock-input::placeholder {
      color: rgba(255, 255, 255, 0.2);
      font-family: 'Poppins', sans-serif;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }
    .lock-btn {
      width: 100%;
      padding: 16px;
      border-radius: 50px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      color: #fff;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .lock-btn:hover {
      background: var(--accent-pink);
      border-color: var(--accent-pink);
      color: #120816;
      box-shadow: 0 0 30px rgba(255, 133, 194, 0.4);
      transform: translateY(-2px);
    }
    .error-msg {
      color: #ff6b6b;
      margin-top: 20px;
      font-size: 0.85rem;
      min-height: 20px;
      opacity: 0;
      transition: opacity 0.3s;
      letter-spacing: 0.5px;
    }
    .error-msg.show { opacity: 1; }

    /* Ambient Background Animation - Starfield */
    .starfield {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0;
      animation: twinkle var(--duration) ease-in-out infinite;
      animation-delay: var(--delay);
    }

    @keyframes twinkle {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: var(--opacity); transform: scale(1); }
      100% { opacity: 0; transform: scale(0.5); }
    }

    /* Ambient Orbs */
    .light-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.3;
      animation: floatOrb 25s infinite ease-in-out;
      z-index: -2;
    }
    @keyframes floatOrb {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, -30px) scale(1.1); }
    }

    /* Navigation */
    .nav-bar {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      padding: 12px 24px;
      background: rgba(20, 20, 30, 0.6);
      backdrop-filter: blur(16px);
      border-radius: 50px;
      border: 1px solid var(--glass-border);
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .nav-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 8px 18px;
      border-radius: 20px;
    }
    .nav-link:hover, .nav-link.active {
      color: #fff;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 15px rgba(255,255,255,0.05);
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 120px auto 40px;
      padding: 0 20px;
    }

    /* Header Section */
    .page-header {
      text-align: center;
      margin-bottom: 50px;
    }
    
    .hero-title {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      margin-bottom: 10px;
      background: linear-gradient(to right, #fff, #ffe0ef);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .subtitle {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Glass Panel */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 40px;
      box-shadow: var(--card-shadow);
      margin-bottom: 50px;
      position: relative;
      overflow: hidden;
    }

    /* Gallery Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 25px;
      padding: 20px 0;
    }
    .gallery-item {
      aspect-ratio: 1;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.05);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      background: rgba(0,0,0,0.2);
    }
    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    .gallery-item.locked img {
      filter: blur(15px) grayscale(0.8) brightness(0.6);
      transform: scale(1.1);
    }
    .gallery-item.locked::after {
      content: 'üîí';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      z-index: 2;
      opacity: 0.7;
    }
    .gallery-item:hover {
      border-color: var(--accent-pink);
      box-shadow: 0 10px 30px rgba(255, 133, 194, 0.2);
      transform: translateY(-8px);
    }
    .gallery-item:hover img {
      transform: scale(1.1);
    }

    /* Puzzle Area */
    .puzzle-section {
      display: none;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.5s ease;
      width: 100%;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .puzzle-header {
      margin-bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 900px;
    }
    
    .action-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 12px 24px;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .action-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
    
    .primary-btn {
      background: linear-gradient(45deg, var(--accent-pink), #ff6b9d);
      border: none;
      color: #120816;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
    }
    .primary-btn:hover {
      box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
      transform: translateY(-2px);
    }

    .puzzle-layout {
      display: flex;
      flex-direction: row;
      gap: 40px;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      max-width: 1100px;
    }
    .puzzle-board {
      position: relative;
      background-color: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .drop-zone {
      position: absolute;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.1);
      transition: background 0.2s;
      cursor: pointer;
    }
    .drop-zone:hover {
      background-color: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.3);
    }

    .tray-container {
      width: 340px;
      min-height: 400px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-content: flex-start;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .piece {
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.2s ease;
      border-radius: 4px;
    }
    .piece:hover { transform: scale(1.05); z-index: 5; }
    .piece.selected {
      border: 2px solid var(--accent-blue);
      box-shadow: 0 0 20px var(--accent-blue);
      transform: scale(1.1);
      z-index: 100;
    }
    .piece.placed {
      position: absolute; top: 0; left: 0; transform: none !important; box-shadow: none; border-radius: 0;
    }

    /* Star Map Custom */
    .starmap-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #000;
      border-radius: 24px;
      overflow: hidden;
      margin-top: 20px;
    }

    /* Carousel Music Player */
    .carousel-player-container {
      background: rgba(18, 18, 24, 0.85);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 32px;
      padding: 40px;
      margin-top: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
      position: relative;
    }
    
    .music-header {
      width: 100%;
      text-align: center;
      margin-bottom: 30px;
    }

    .music-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      margin: 0;
      background: linear-gradient(to right, #8ae6ff, #ff85c2);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .player-carousel {
      display: flex;
      align-items: center;
      gap: 30px;
      position: relative;
      width: 100%;
      justify-content: center;
    }

    .nav-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .nav-btn:hover {
      background: var(--accent-pink);
      color: #120816;
      transform: scale(1.15);
      box-shadow: 0 0 25px rgba(255, 133, 194, 0.6);
      border-color: transparent;
    }
    .nav-btn:active {
      transform: scale(0.95);
    }

    .player-frame-wrapper {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      background: #000;
      transition: transform 0.5s ease;
      width: 380px;
      height: 380px;
      flex-shrink: 0;
    }
    
    .player-frame-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .song-info-display {
      margin-top: 25px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    
    .current-song-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #fff;
      margin: 0 0 5px 0;
    }
    
    .current-song-artist {
      font-size: 1rem;
      color: var(--accent-blue);
      opacity: 0.8;
      margin: 0;
    }

    .carousel-dots {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 80%;
    }
    .dot {
      width: 6px;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transition: all 0.3s;
    }
    .dot.active {
      background: var(--accent-pink);
      transform: scale(1.5);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 18, 22, 0.9);
      backdrop-filter: blur(10px);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .modal.show { display: flex; opacity: 1; }
    .modal-card {
      background: linear-gradient(135deg, #fdfbf7, #f4e4e9);
      padding: 50px;
      border-radius: 40px;
      text-align: center;
      max-width: 90%;
      width: 600px;
      color: #2a0d2f;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.6);
    }
    .modal.show .modal-card { transform: scale(1); }
    
    .modal-text {
      font-size: 1.35rem;
      line-height: 1.8;
      margin-bottom: 35px;
      white-space: pre-line;
      color: #4a2c4a;
      font-family: 'Playfair Display', serif;
    }

    /* Full Image */
    .full-image-container {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.98);
      z-index: 4000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .full-image-container.show { display: flex; }
    .full-image-container img {
      max-width: 100%;
      max-height: 85vh;
      border-radius: 12px;
      box-shadow: 0 0 60px rgba(0,0,0,0.8);
      object-fit: contain;
    }
    .controls { margin-top: 30px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }

    /* Floating Hearts */
    .floating-heart {
      position: fixed;
      pointer-events: none;
      color: #ff85c2;
      animation: floatUp 2.5s ease-out forwards;
      z-index: 9999;
      font-size: 2rem;
      text-shadow: 0 0 10px rgba(255, 133, 194, 0.5);
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.5); opacity: 0; }
      10% { opacity: 1; transform: translateY(-20px) scale(1.2); }
      100% { opacity: 0; transform: translateY(-100vh) scale(1); }
    }

    /* Responsive */
    @media (max-width: 900px) {
      .puzzle-layout {
        flex-direction: column;
        align-items: center;
      }
      .tray-container { width: 100%; max-height: 250px; }
      
      .player-carousel {
        flex-direction: column;
        gap: 20px;
      }
      .nav-btn {
        width: 50px; height: 50px; font-size: 1.2rem;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }
      .prev-btn { left: -10px; }
      .next-btn { right: -10px; }
      
      .player-frame-wrapper {
        width: 280px;
        height: 280px;
      }
      
      h1 { font-size: 2.2rem; }
      .modal-text { font-size: 1.1rem; }
    }
  </style>
  <script>
    // Define globally in head to ensure availability
    var attempts = 0;
    window.attemptUnlock = function() {
      const input = document.getElementById('passwordInput');
      const errorMsg = document.getElementById('errorMsg');
      const lockScreen = document.getElementById('lockScreen');
      
      if (!input || !lockScreen) return;

      // Password: "Stendhal"
      if(input.value.trim() === 'Stendhal') {
        lockScreen.classList.add('hidden');
        sessionStorage.setItem('unlocked_index4', 'true');
        attempts = 0;
      } else {
        attempts++;
        if(errorMsg) {
            if (attempts >= 3) {
                errorMsg.textContent = "Contacta con sistemas";
                errorMsg.classList.add('show');
                // Keep the critical error shown longer
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                    // Reset text after hide
                    setTimeout(() => { errorMsg.textContent = "La respuesta no es correcta."; }, 300);
                }, 4000);
            } else {
                errorMsg.textContent = "La respuesta no es correcta.";
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 2000);
            }
        }
        input.value = '';
        input.focus();
      }
    };
  </script>
</head>
<body>

  <!-- Lock Screen -->
  <div id="lockScreen">
    <div class="lock-card">
      <div class="lock-icon">üóùÔ∏è</div>
      <h2 class="lock-title">Acceso Restringido</h2>
      <div class="lock-riddle">
        <p style="margin-bottom: 15px; font-style: italic;">
          "Soy ese temblor que nace cuando la belleza es excesiva, cuando el arte abruma, acelera el pulso y el alma no sabe si admirar, huir o rendirse. Eres el nombre que se le dio al instante en que lo bello deja de ser contemplaci√≥n y se convierte en experiencia f√≠sica del esp√≠ritu."
        </p>
        <span style="font-size: 0.8rem; opacity: 0.5; text-transform: uppercase; letter-spacing: 2px;">¬øQui√©n soy?</span>
      </div>
      
      <div class="lock-input-group">
        <input type="password" id="passwordInput" class="lock-input" placeholder="Escribe la respuesta" />
      </div>
      
      <button class="lock-btn" onclick="attemptUnlock()">Desbloquear</button>
      <div id="errorMsg" class="error-msg">La respuesta no es correcta.</div>
    </div>
  </div>

  <!-- Background FX -->
  <div class="starfield" id="starfield"></div>
  <div class="ambient-light">
    <div class="light-orb" style="top: 10%; left: 20%; width: 400px; height: 400px; background: radial-gradient(circle, var(--accent-pink), transparent);"></div>
    <div class="light-orb" style="bottom: 20%; right: 10%; width: 500px; height: 500px; background: radial-gradient(circle, var(--accent-blue), transparent); animation-delay: -5s;"></div>
  </div>

  <!-- Navigation -->
  <div class="nav-bar">
    <a href="index.html" class="nav-link">Inicio</a>
    <a href="AYECHAT/index.html" class="nav-link">Chat Privado</a>
    <a href="index2.html" class="nav-link">Playlist</a>
    <a href="index3.html" class="nav-link">Flores</a>
    <a href="index4.html" class="nav-link active">Momentos</a>
    <a href="index5.html" class="nav-link">San Valent√≠n</a>
  </div>

  <div class="container">
    
    <!-- Header -->
    <div class="page-header">
      <h1 class="hero-title">Nuestra Historia</h1>
      <p class="subtitle">Cada pieza es un recuerdo, cada recuerdo una historia.</p>
    </div>

    <!-- Gallery & Puzzle Section -->
    <div class="glass-panel">
      <h2 style="font-family:'Playfair Display', serif; font-size:2rem; margin-bottom:10px;">Galer√≠a de Recuerdos</h2>
      <p class="subtitle" style="margin-bottom:30px; opacity:0.8;">Completa los rompecabezas para desbloquear los mensajes ocultos.</p>
      
      <!-- Gallery -->
      <div id="galleryView" class="gallery-grid"></div>

      <!-- Puzzle -->
      <div id="puzzleSection" class="puzzle-section">
        <div class="puzzle-header">
          <button class="action-btn" onclick="showGallery()">‚Üê Volver</button>
          
          <div style="flex-grow: 1; text-align: center; color: var(--accent-blue); font-size: 0.9rem; padding: 0 20px;">
            <span style="opacity:0.8;">Arma la imagen para descubrir el mensaje.</span>
          </div>

          <button class="action-btn primary-btn" onclick="helpMe()">‚ú® Ayuda M√°gica</button>
        </div>
        
        <div class="puzzle-layout">
          <div class="board-container">
            <div id="puzzleBoard" class="puzzle-board"></div>
          </div>
          <div id="puzzleTray" class="tray-container" onclick="handleTrayClick(event)">
             <div style="width:100%; text-align:center; color:rgba(255,255,255,0.3); font-size:0.8rem; margin-top:20px;">
               Tus piezas aparecer√°n aqu√≠
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Star Map Section -->
    <div class="glass-panel" style="background: rgba(10, 10, 15, 0.5); text-align:center;">
        <h2 style="font-family:'Playfair Display', serif; font-size:2.2rem; margin-bottom:10px;">Bajo este cielo coincidimos</h2>
        
        <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: center;">
          <button class="action-btn" onclick="updateStarMap('july16')">16 Jul 2025</button>
          <button class="action-btn" onclick="updateStarMap('dec22')">22 Dic 2025</button>
        </div>

        <p id="starMapInfo" style="color:var(--text-muted); margin-bottom:30px; line-height:1.6; transition: opacity 0.5s;">
            22 de Diciembre de 2025 ‚Ä¢ CESUN Universidad<br>
            <span style="font-size:0.9rem; opacity:0.8; color:var(--accent-blue);">32.4998¬∞ N, 116.9297¬∞ O</span><br>
            <span style="font-size:0.8rem; opacity:0.6;">Blvd. Cucap√°h Sur #20100, Fracc. El Lago, 22210 Tijuana, B.C.</span>
        </p>
        <div class="starmap-container">
           <div id="starmap" style="width:100%; height:100%;"></div>
        </div>
        <p style="font-size:0.85rem; opacity:0.5; margin-top:20px; font-style:italic;">
            "Mira las estrellas, mira c√≥mo brillan por ti."
        </p>
    </div>

    <!-- CAROUSEL Music Player -->
    <div class="carousel-player-container">
      <div class="music-header">
        <h2 class="music-title">Banda Sonora</h2>
        <p style="color:var(--text-muted); margin: 5px 0 0 0; font-size:0.9rem; opacity:0.7;">Canciones que suenan a ti</p>
      </div>

      <div class="player-carousel">
         <button class="nav-btn prev-btn" onclick="prevTrack()" title="Anterior">‚ùÆ</button>
         
         <div class="player-content">
             <div class="player-frame-wrapper">
                <iframe id="spotifyFrame" src="" allow="autoplay; encrypted-media" allowfullscreen="" loading="eager"></iframe>
             </div>
             
             <div class="song-info-display">
                <h3 id="currentSongTitle" class="current-song-title">Cargando...</h3>
                <p id="currentSongArtist" class="current-song-artist">...</p>
             </div>
         </div>

         <button class="nav-btn next-btn" onclick="nextTrack()" title="Siguiente">‚ùØ</button>
      </div>

      <div class="carousel-dots" id="carouselDots"></div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-card">
      <h2 style="font-family:'Playfair Display',serif; margin-bottom:10px; color:var(--accent-pink);">¬°Recuerdo Desbloqueado!</h2>
      <div style="font-size:3rem; margin-bottom:20px;">‚ú®</div>
      <p id="successMessage" class="modal-text"></p>
      <div class="controls">
        <button class="action-btn primary-btn" onclick="closeSuccessAndShowImage()">Ver Foto Completa</button>
      </div>
    </div>
  </div>

  <!-- Full Image Modal -->
  <div id="fullImageModal" class="full-image-container">
    <img id="fullImageDisplay" src="" alt="Recuerdo Completo">
    <div class="controls">
        <button class="action-btn" onclick="readMessageAgain()">üíå Leer Carta</button>
        <button class="action-btn" onclick="resetPuzzle()">üß© Armar de nuevo</button>
        <button class="action-btn" onclick="closeFullImage()">Cerrar</button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <!-- VirtualSky Libraries (Local Patch) -->
  <script src="js/stuquery.js"></script>
  <script src="https://slowe.github.io/VirtualSky/virtualsky.js"></script>

  <script>
    // --- Password Protection Init ---
    window.addEventListener('DOMContentLoaded', () => {
      if(sessionStorage.getItem('unlocked_index4') === 'true') {
        const lock = document.getElementById('lockScreen');
        if(lock) lock.classList.add('hidden');
      }
      
      const passInput = document.getElementById('passwordInput');
      if(passInput) {
        passInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') window.attemptUnlock();
        });
      }
    });
  </script>

  <script>
    let planetarium;
    
    // Dates: Month is 0-indexed (0=Jan, 6=July, 11=Dec)
    const starMapData = {
      'july16': {
        date: new Date(2025, 6, 16, 20, 0, 0), // July 16, 2025, 8:00 PM
        html: `16 de Julio de 2025 ‚Ä¢ El Primer Encuentro<br>
               <span style="font-size:0.9rem; opacity:0.8; color:var(--accent-blue);">32.4998¬∞ N, 116.9297¬∞ O</span><br>
               <span style="font-size:0.8rem; opacity:0.6;">"Cuando te vi, dije que eras muy bonita."</span>`
      },
      'dec22': {
        date: new Date(2025, 11, 22, 20, 0, 0), // Dec 22, 2025, 8:00 PM
        html: `22 de Diciembre de 2025 ‚Ä¢ CESUN Universidad<br>
               <span style="font-size:0.9rem; opacity:0.8; color:var(--accent-blue);">32.4998¬∞ N, 116.9297¬∞ O</span><br>
               <span style="font-size:0.8rem; opacity:0.6;">Blvd. Cucap√°h Sur #20100, Fracc. El Lago, 22210 Tijuana, B.C.</span>`
      }
    };

    // --- Star Map ---
    function initStarMap() {
        S(document).ready(function(){
            planetarium = S.virtualsky({
                id: 'starmap',
                projection: 'stereo',
                latitude: 32.4998, 
                longitude: -116.9297,
                date: new Date(2025, 11, 22, 20, 0, 0), // Initial: Dec 22, 2025
                constellations: true,
                gridlines_az: false,
                gridlines_eq: false,
                showgalaxy: true,
                stars: true,
                showplanets: true,
                color: 'white',
                background: 'rgba(0,0,0,0)', 
                lang: 'es',
                mouse: true,
                live: false // Disable auto-update of time
            });
            
            let azimuth = 0;
            setInterval(() => {
                if(planetarium) {
                  azimuth += 0.002; // Slower rotation
                  planetarium.az = azimuth;
                  planetarium.draw();
                }
            }, 50);
        });
    }
    
    function updateStarMap(key) {
      if(!planetarium || !starMapData[key]) return;
      
      const info = document.getElementById('starMapInfo');
      const data = starMapData[key];
      
      // Fade out text
      info.style.opacity = '0';
      
      setTimeout(() => {
        // Update data
        info.innerHTML = data.html;
        
        // Update date directly
        if(planetarium) {
            // VirtualSky sometimes needs robust date setting
            planetarium.date = new Date(data.date); 
            // Also update latitude/longitude if they were different (they are same here but good practice)
            planetarium.draw();
        }
        
        // Fade in text
        info.style.opacity = '1';
      }, 300);
    }

    function createStars() {
      const starfield = document.getElementById('starfield');
      const count = 60; 
      
      for(let i=0; i<count; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const xy = [Math.random() * 100, Math.random() * 100];
        const duration = 2 + Math.random() * 3;
        const size = 1 + Math.random() * 3;
        const delay = Math.random() * 5;
        const opacity = 0.2 + Math.random() * 0.6;

        star.style.left = `${xy[0]}%`;
        star.style.top = `${xy[1]}%`;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.setProperty('--duration', `${duration}s`);
        star.style.setProperty('--delay', `${delay}s`);
        star.style.setProperty('--opacity', opacity);

        starfield.appendChild(star);
      }
    }
    createStars();
    initStarMap();

    // --- Heart Click FX ---
    document.addEventListener('click', (e) => {
      if(document.getElementById('lockScreen').style.opacity === '1' || !document.getElementById('lockScreen').classList.contains('hidden')) return;
      if(e.target.closest('button') || 
         e.target.closest('.gallery-item') || 
         e.target.closest('.piece') || 
         e.target.closest('.nav-btn') || 
         e.target.closest('input') ||
         e.target.closest('.puzzle-board') ||
         e.target.closest('.tray-container') ||
         e.target.closest('.starmap-container')) return;

      const heart = document.createElement('div');
      heart.className = 'floating-heart';
      const emojis = ['üíñ', '‚ú®', 'üå∏', 'ü¶ã', 'ü¶ä'];
      heart.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      heart.style.left = (e.clientX - 15) + 'px';
      heart.style.top = (e.clientY - 15) + 'px';
      document.body.appendChild(heart);
      
      setTimeout(() => heart.remove(), 2500);
    });

    // --- Music Player (Carousel Logic) ---
    const playlist = [
      { id: '21TtgKp33wm2fLPqgq5591', title: 'Cuenta Conmigo', artist: 'R√≠o Roma' },
      { id: '4f0jYdCQUUR7tEWj1vETuL', title: 'Solamente T√∫', artist: 'Pablo Albor√°n' },
      { id: '2KWQgEXc3ZzX6npPgIEqSB', title: 'Eso y M√°s', artist: 'Joan Sebastian' },
      { id: '0v9UztY5A12cJUsWD7PZzS', title: 'Amor de Cine', artist: 'Humbe' },
      { id: '5rcnAHBclBs0OGV4rATEnR', title: 'Fantasmas', artist: 'Humbe' },
      { id: '609ItcFreOqmwRjmBbocds', title: 'Te lo prometo', artist: 'Humbe' },
      { id: '3dCaq6gk0XBCSfnlupKJ5r', title: 'Manifiesto', artist: 'Humbe' },
      { id: '5I0aHj2JSQpoxSQnh3XcjO', title: 'Te Amo', artist: 'Libro' },
      { id: '1mlGScrDQqHqmhdIqE8MmA', title: 'Besos en Guerra', artist: 'Morat' },
      { id: '3zNcn4BaVfKORyx3uDfruW', title: 'Aprender a Quererte', artist: 'Morat' },
      { id: '5CNOFIWQNKpjIhjDmdjPyn', title: 'Mi Suerte', artist: 'Morat' },
      { id: '4wTuLXjSiiWxHO0e1Pwf1X', title: 'Te Regalo', artist: 'Carla Morrison' },
      { id: '3AJwUDP919kvQ9QcozQPxg', title: 'Yellow', artist: 'Coldplay' },
      { id: '7oEkDWQeUlsu3UBfltE1WI', title: 'Fix You', artist: 'Coldplay' },
      { id: '2Ga1FnYssxRlMukIDI0f0y', title: 'Ojos Marrones', artist: 'Lasso' },
      { id: '6d3q0F9VNtdxQUTVlRcet6', title: 'Querer Querernos', artist: 'Canserbero' },
      { id: '1HNkqx9Ahdgi1Ixy2xkKkL', title: 'Photograph', artist: 'Ed Sheeran' },
      { id: '0SRddBTphQwQcfqw4Br1uX', title: 'Brillas', artist: 'Le√≥n Larregui' },
      { id: '7BqBn9nzAq8spo5e7cZ0dJ', title: 'Just the Way You Are', artist: 'Bruno Mars' },
      { id: '3GjB3hDdFN5LtZvX4KPeHl', title: 'C√≥mo Te Atreves', artist: 'Morat' },
      { id: '2sygPOe47UOKoEv1D5ZNAb', title: 'No Se Va', artist: 'Morat' },
      { id: '1Tep3xsXYJgAhlQjMqUdkd', title: 'Creo en Ti', artist: 'Reik' },
      { id: '0Snbzbd74RLfL0i4nn1vU5', title: 'Favorito', artist: 'Camilo' },
      { id: '1nocRtwyNPVtGcIJqfgdzZ', title: 'Tutu', artist: 'Camilo' },
      { id: '161DnLWsx1i3u1JT05lzqU', title: 'Talking to the Moon', artist: 'Bruno Mars' },
      { id: '0nJW01T7XtvILxQgC5J7Wh', title: 'When I Was Your Man', artist: 'Bruno Mars' }
    ];

    let currentTrackIndex = 0;

    function initPlayer() {
        // Create dots
        const dotsContainer = document.getElementById('carouselDots');
        dotsContainer.innerHTML = '';
        
        // Limit dots to avoid overflow if playlist is huge, or just show all
        // For 20+ songs, maybe we don't show all dots, or we make them small. 
        // Let's just show active indicator text or limit dots visually? 
        // Showing all dots for now.
        playlist.forEach((_, idx) => {
           const dot = document.createElement('div');
           dot.className = `dot ${idx === 0 ? 'active' : ''}`;
           // Optional: Click dot to jump
           // dot.onclick = () => loadTrack(idx); 
           dotsContainer.appendChild(dot);
        });

        loadTrack(0);
    }

    function loadTrack(index) {
        if (index < 0) index = playlist.length - 1;
        if (index >= playlist.length) index = 0;
        
        currentTrackIndex = index;
        
        const track = playlist[index];
        const iframe = document.getElementById('spotifyFrame');
        
        // Update iframe
        const newSrc = `https://open.spotify.com/embed/track/${track.id}?utm_source=generator&theme=0&autoplay=1`;
        if (iframe.src !== newSrc) {
            iframe.src = newSrc;
        }

        // Update Text
        document.getElementById('currentSongTitle').textContent = track.title;
        document.getElementById('currentSongArtist').textContent = track.artist;

        // Update Dots
        const dots = document.querySelectorAll('.dot');
        dots.forEach(d => d.classList.remove('active'));
        if(dots[currentTrackIndex]) dots[currentTrackIndex].classList.add('active');
    }

    function nextTrack() {
        loadTrack(currentTrackIndex + 1);
    }

    function prevTrack() {
        loadTrack(currentTrackIndex - 1);
    }
    
    initPlayer();


    // --- Gallery & Puzzle Config ---
    const imageList = [
      'Images/principal.jpeg',
      'Images/principal2.jpeg',
      'Images/principal3.jpeg',
      'Images/principal4.jpeg',
      'Images/principal5.jpeg',
      'Images/principal6.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.08 PM (1).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.08 PM (2).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.09 PM (2).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.09 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.16 PM (3).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 2.43.16 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.11 PM (1).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.11 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.12 PM (1).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.12 PM (2).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.12 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (1).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (2).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (3).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (4).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (5).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM (6).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.13 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (1).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (2).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (3).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (4).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (5).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (6).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM (7).jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.14 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.15.15 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.53.25 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.53.26 PM.jpeg',
      'Images/WhatsApp Image 2026-01-04 at 1.53.36 PM.jpeg'
    ];

    const messagesMap = {
      'principal.jpeg': `Te he regalado mi tiempo porque en ti todo vale la pena;
te entregu√© mi atenci√≥n porque, sin pedirla, la conquistaste.
Mi coraz√≥n es tuyo por razones que no caben en palabras,
y aun en la distancia, aun cuando no estemos juntos,
siempre estar√© a tu lado, de la forma m√°s sincera que existe.`,
      
      'principal2.jpeg': `Mis ojos te eligieron antes de que mi voz supiera tu nombre.
Te quise en silencio, en miradas largas,
y desde entonces todo lo dem√°s fue solo confirmaci√≥n.`,

      'principal3.jpeg': `El cari√±o verdadero no llega con promesas,
llega con gestos simples, manos temblando
y un coraz√≥n que se atreve a ofrecer lo que tiene.`,

      'principal4.jpeg': `Ir√≠a por ti incluso a los lugares donde el miedo se queda,
porque amarte es elegirte
aun cuando el mundo no supo hacerlo conmigo.`,

      'principal5.jpeg': `Caminar contigo es entender
que no importa el destino,
mientras nuestras manos sigan encontr√°ndose
entre el caos y la belleza.`,

      'principal6.jpeg': `Te amo m√°s all√° de lo visible,
hasta donde la noche guarda estrellas,
hasta donde el universo aprende a pronunciar tu nombre,
y un poco m√°s‚Ä¶ solo por si acaso.`
    };

    const genericMessages = [
      "Gracias por estar en mi vida ‚ù§Ô∏è",
      "Cada momento contigo es un regalo.",
      "Eres mi persona favorita.",
      "Me haces sonre√≠r sin darte cuenta.",
      "Contigo todo es m√°s bonito.",
      "Adoro crear recuerdos contigo."
    ];

    const gridSize = 3; 
    let currentImage = '';
    let selectedPiece = null;
    let boardState = []; 

    function isUnlocked(src) { return localStorage.getItem('puzzle_' + src) === 'true'; }
    function setUnlocked(src) { localStorage.setItem('puzzle_' + src, 'true'); }

    const galleryGrid = document.getElementById('galleryView');
    const puzzleSection = document.getElementById('puzzleSection');
    const puzzleBoard = document.getElementById('puzzleBoard');
    const puzzleTray = document.getElementById('puzzleTray');

    function initGallery() {
      galleryGrid.innerHTML = '';
      imageList.forEach((src, index) => {
        const div = document.createElement('div');
        const unlocked = isUnlocked(src);
        div.className = `gallery-item ${unlocked ? 'unlocked' : 'locked'}`;
        div.innerHTML = `
            <img src="${src}" alt="Recuerdo" loading="lazy">
            ${unlocked ? '<div style="position:absolute;bottom:10px;right:10px;font-size:1.5rem;">‚ú®</div>' : ''}
        `;
        div.onclick = () => {
          if (unlocked) {
            currentImage = src;
            showFullImage(src);
          } else {
            startPuzzle(src);
          }
        };
        galleryGrid.appendChild(div);
      });
    }

    function startPuzzle(src) {
      currentImage = src;
      galleryGrid.style.display = 'none';
      puzzleSection.style.display = 'flex';
      
      const img = new Image();
      img.src = src;
      img.onload = () => buildBoard(src, img.width, img.height);
    }

    function buildBoard(imgUrl, w, h) {
      puzzleBoard.innerHTML = '';
      puzzleTray.innerHTML = '';
      selectedPiece = null;
      boardState = new Array(gridSize * gridSize).fill(null).map(() => ({ occupied: null, locked: false }));

      const maxW = Math.min(window.innerWidth - 40, 500);
      const scale = maxW / w;
      const boardW = maxW;
      const boardH = h * scale;

      puzzleBoard.style.width = `${boardW}px`;
      puzzleBoard.style.height = `${boardH}px`;

      const pieceW = boardW / gridSize;
      const pieceH = boardH / gridSize;

      for(let i=0; i<gridSize*gridSize; i++) {
        const x = i % gridSize;
        const y = Math.floor(i / gridSize);
        const zone = document.createElement('div');
        zone.className = 'drop-zone';
        zone.style.width = `${pieceW}px`;
        zone.style.height = `${pieceH}px`;
        zone.style.left = `${x * pieceW}px`;
        zone.style.top = `${y * pieceH}px`;
        zone.onclick = () => handleZoneClick(i, zone);
        puzzleBoard.appendChild(zone);
      }

      const pieces = [];
      for(let i=0; i<gridSize*gridSize; i++) {
        const x = i % gridSize;
        const y = Math.floor(i / gridSize);
        const piece = document.createElement('div');
        piece.className = 'piece';
        piece.style.width = `${pieceW}px`;
        piece.style.height = `${pieceH}px`;
        piece.style.backgroundImage = `url('${imgUrl}')`;
        piece.style.backgroundSize = `${boardW}px ${boardH}px`;
        piece.style.backgroundPosition = `-${x * pieceW}px -${y * pieceH}px`;
        piece.dataset.correctIndex = i; 
        piece.onclick = (e) => {
          e.stopPropagation();
          handlePieceClick(piece);
        };
        pieces.push(piece);
      }
      pieces.sort(() => Math.random() - 0.5);
      pieces.forEach(p => puzzleTray.appendChild(p));
    }

    function handlePieceClick(piece) {
      if (piece.classList.contains('correct')) return;
      if (selectedPiece === piece) {
        piece.classList.remove('selected');
        selectedPiece = null;
        return;
      }
      if (selectedPiece) selectedPiece.classList.remove('selected');
      selectedPiece = piece;
      piece.classList.add('selected');
    }

    function handleZoneClick(index, zone) {
      if (!selectedPiece) return;
      if (boardState[index].locked) return;
      const currentOccupant = boardState[index].occupied;
      if (currentOccupant) {
        returnToTray(currentOccupant);
        boardState[index].occupied = null;
      }
      placePieceInZone(selectedPiece, zone, index);
    }

    function handleTrayClick(e) {
      if (!selectedPiece) return;
      returnToTray(selectedPiece);
      selectedPiece.classList.remove('selected');
      selectedPiece = null;
    }

    function returnToTray(piece) {
      if (piece.parentElement === puzzleBoard) {
        const oldIndex = boardState.findIndex(s => s.occupied === piece);
        if (oldIndex !== -1) boardState[oldIndex].occupied = null;
      }
      piece.classList.remove('placed', 'correct');
      piece.style.position = 'relative';
      piece.style.left = '';
      piece.style.top = '';
      puzzleTray.appendChild(piece);
    }

    function placePieceInZone(piece, zone, index) {
      if (piece.parentElement === puzzleBoard) {
        const oldIndex = boardState.findIndex(s => s.occupied === piece);
        if (oldIndex !== -1) boardState[oldIndex].occupied = null;
      }
      piece.classList.remove('selected');
      piece.classList.add('placed');
      piece.style.position = 'absolute';
      piece.style.left = zone.style.left;
      piece.style.top = zone.style.top;
      puzzleBoard.appendChild(piece);
      boardState[index].occupied = piece;
      selectedPiece = null;
      const correctIndex = parseInt(piece.dataset.correctIndex);
      if (correctIndex === index) {
        piece.classList.add('correct');
        boardState[index].locked = true;
        checkWin();
      }
    }

    function checkWin() {
      if (boardState.every(s => s.locked)) {
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        setTimeout(showSuccess, 1000);
      }
    }

    function helpMe() {
      const availableIndices = [];
      boardState.forEach((state, idx) => { if (!state.locked) availableIndices.push(idx); });
      if (availableIndices.length === 0) return;
      const targetIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
      const allPieces = Array.from(document.querySelectorAll('.piece'));
      const correctPiece = allPieces.find(p => parseInt(p.dataset.correctIndex) === targetIndex);
      if (!correctPiece) return;
      if (boardState[targetIndex].occupied) {
        returnToTray(boardState[targetIndex].occupied);
        boardState[targetIndex].occupied = null;
      }
      if (correctPiece.parentElement === puzzleBoard) {
        const oldIdx = boardState.findIndex(s => s.occupied === correctPiece);
        if (oldIdx !== -1) boardState[oldIdx].occupied = null;
      }
      const zone = document.querySelectorAll('.drop-zone')[targetIndex];
      placePieceInZone(correctPiece, zone, targetIndex);
    }

    function showSuccess() {
      setUnlocked(currentImage);
      let msg = genericMessages[Math.floor(Math.random() * genericMessages.length)];
      for (const [key, value] of Object.entries(messagesMap)) {
        if (currentImage.includes(key)) {
          msg = value;
          break;
        }
      }
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successModal').classList.add('show');
    }

    function closeSuccessAndShowImage() {
      document.getElementById('successModal').classList.remove('show');
      showFullImage(currentImage);
    }

    function showFullImage(src) {
      const container = document.getElementById('fullImageModal');
      document.getElementById('fullImageDisplay').src = src;
      container.classList.add('show');
    }

    function closeFullImage() {
      document.getElementById('fullImageModal').classList.remove('show');
      if (puzzleSection.style.display !== 'none') showGallery();
    }

    function readMessageAgain() {
        let msg = genericMessages[Math.floor(Math.random() * genericMessages.length)];
        for (const [key, value] of Object.entries(messagesMap)) {
            if (currentImage.includes(key)) {
            msg = value;
            break;
            }
        }
        document.getElementById('successMessage').textContent = msg;
        document.getElementById('fullImageModal').classList.remove('show');
        document.getElementById('successModal').classList.add('show');
    }

    function resetPuzzle() {
      if(!currentImage) return;
      // Remove lock from storage
      localStorage.removeItem('puzzle_' + currentImage);
      // Close the modal
      document.getElementById('fullImageModal').classList.remove('show');
      // Start the puzzle fresh
      startPuzzle(currentImage);
    }

    function showGallery() {
      puzzleSection.style.display = 'none';
      galleryGrid.style.display = 'grid';
      initGallery();
    }

    initGallery();
  </script>
</body>
</html>
